// ===========================================
// PRISMA SCHEMA CHO ORDER SERVICE
// Database: PostgreSQL (S·ª≠ d·ª•ng UUID cho ID)
// ===========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// ‚ö†Ô∏è EXTERNAL REFERENCES (Tham chi·∫øu ngo√†i - KH√îNG T·∫†O B·∫¢NG)
// ===========================================

// User: L·∫•y ID t·ª´ Auth Service
model User {
  id      String @id @default(uuid()) @db.Uuid
  orders  Order[] // Quan h·ªá ng∆∞·ª£c (Optional)
  
  @@map("users") 
}

// Product Variant: L·∫•y ID t·ª´ Product Service
model ProductVariant {
  id          String      @id @default(uuid()) @db.Uuid
  order_items OrderItem[] // Quan h·ªá ng∆∞·ª£c (Optional)
  
  @@map("product_variants") 
}


// ===========================================
// üõí ORDER SERVICE OWNED COLLECTIONS
// ===========================================

// 1. ORDERS (ƒê∆°n h√†ng)
model Order {
  id               String      @id @default(uuid()) @db.Uuid
  user_id          String      @db.Uuid
  total_amount     Float       // T·ªïng ti·ªÅn cu·ªëi c√πng (sau khi √°p d·ª•ng ph√≠ ship/gi·∫£m gi√°)
  
  // Th√¥ng tin giao h√†ng
  shipping_address String
  receiver_name    String
  receiver_phone   String
  tracking_code    String?     // M√£ v·∫≠n ƒë∆°n

  // Tr·∫°ng th√°i & Ph∆∞∆°ng th·ª©c
  payment_method   PaymentMethod @default(COD)
  payment_status   PaymentStatus @default(PENDING)
  shipping_method  ShippingMethod @default(STANDARD)
  shipping_fee     Float         @default(0)
  shipping_status  ShippingStatus @default(PENDING)

  // M·ªëi quan h·ªá
  user             User          @relation(fields: [user_id], references: [id])
  order_items      OrderItem[]   // Chi ti·∫øt s·∫£n ph·∫©m
  payments         Payment[]     // B·∫£n ghi thanh to√°n
  shipping_logs    ShippingLog[] // Log v·∫≠n chuy·ªÉn

  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")

  @@map("orders")
}

// 2. ORDER ITEMS (Chi ti·∫øt s·∫£n ph·∫©m trong ƒë∆°n h√†ng)
model OrderItem {
  id                  String  @id @default(uuid()) @db.Uuid
  order_id            String  @db.Uuid
  product_variant_id  String  @db.Uuid 
  quantity            Int
  price               Float // Gi√° b√°n t·∫°i th·ªùi ƒëi·ªÉm ƒë·∫∑t h√†ng (ƒê√£ bao g·ªìm gi·∫£m gi√° s·∫£n ph·∫©m n·∫øu c√≥)

  // M·ªëi quan h·ªá
  order               Order           @relation(fields: [order_id], references: [id])
  product_variant     ProductVariant  @relation(fields: [product_variant_id], references: [id])
  
  @@map("order_items")
}

// 3. PAYMENTS (Giao d·ªãch Thanh to√°n)
model Payment {
  id              String         @id @default(uuid()) @db.Uuid
  order_id        String         @db.Uuid
  amount          Float
  method          PaymentMethod
  status          PaymentStatus  @default(PENDING)
  transaction_id  String?        // M√£ giao d·ªãch t·ª´ c·ªïng thanh to√°n

  // M·ªëi quan h·ªá
  order           Order          @relation(fields: [order_id], references: [id])
  
  created_at      DateTime       @default(now()) @map("created_at")

  @@map("payments")
}

// 4. SHIPPING LOGS (L·ªãch s·ª≠ V·∫≠n chuy·ªÉn)
model ShippingLog {
  id              String           @id @default(uuid()) @db.Uuid
  order_id        String           @db.Uuid
  status          ShippingStatusLog
  note            String?
  
  // M·ªëi quan h·ªá
  order           Order            @relation(fields: [order_id], references: [id])

  updated_at      DateTime         @default(now()) @map("updated_at")
  
  @@map("shipping_logs")
}

// ===========================================
// ENUMS (Li·ªát k√™)
// ===========================================

enum PaymentMethod {
  COD
  MOMO
  ZALOPAY
  PAYPAL
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
}

enum ShippingMethod {
  STANDARD
  EXPRESS
  PICKUP
}

enum ShippingStatus {
  PENDING
  PROCESSING
  SHIPPING
  DELIVERED
  CANCELLED
  RETURNED
}

// Log chi ti·∫øt tr·∫°ng th√°i v·∫≠n chuy·ªÉn
enum ShippingStatusLog {
  PROCESSING
  PICKUP
  SHIPPING
  DELIVERED
  FAILED
  RETURNED
}